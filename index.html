<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Doc - Capture A4 Photo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: inline-block;
      width: 100px;
    }
    input {
      margin-bottom: 10px;
      width: 200px;
      padding: 5px;
    }
    #result {
      margin-top: 20px;
      white-space: normal;
    }
  </style>
</head>
<body>
  <h1>Tirar a foto</h1>
  <video id="video" width="320" height="240" autoplay playsinline></video>
  <br />
  <button id="start-camera">Iniciar câmera</button>
  <button id="snap" disabled>CAPTURAR</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const startBtn = document.getElementById('start-camera');
    const snapBtn = document.getElementById('snap');

    // A4 size at 150 dpi (adjust dpi if needed)
    const dpi = 150;
    const mmToInch = 0.0393701;
    const a4WidthPx = Math.round(210 * mmToInch * dpi);
    const a4HeightPx = Math.round(297 * mmToInch * dpi);

    canvas.width = a4WidthPx;
    canvas.height = a4HeightPx;

    let stream;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } },
          audio: false
        });
        video.srcObject = stream;
        snapBtn.disabled = false;
        startBtn.disabled = true;
      } catch (err) {
        // Fallback if exact facingMode fails
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false
          });
          video.srcObject = stream;
          snapBtn.disabled = false;
          startBtn.disabled = true;
        } catch (err2) {
          console.error('Erro ao acessar a câmera traseira:', err2);
          resultDiv.textContent = 'Erro ao acessar a câmera traseira: ' + err2.message;
        }
      }
    }

    startBtn.addEventListener('click', startCamera);

    snapBtn.addEventListener('click', async () => {
      if (!stream) {
        resultDiv.textContent = 'Câmera não iniciada.';
        return;
      }

      // Wait for video metadata to load for dimensions
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        resultDiv.textContent = 'Aguardando a câmera iniciar...';
        return;
      }

      // Calculate aspect ratios
      const videoRatio = video.videoWidth / video.videoHeight;
      const canvasRatio = canvas.width / canvas.height;

      let drawWidth, drawHeight, offsetX, offsetY;

      if (videoRatio > canvasRatio) {
        drawWidth = canvas.width;
        drawHeight = canvas.width / videoRatio;
        offsetX = 0;
        offsetY = (canvas.height - drawHeight) / 2;
      } else {
        drawHeight = canvas.height;
        drawWidth = canvas.height * videoRatio;
        offsetX = (canvas.width - drawWidth) / 2;
        offsetY = 0;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);

      const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];

      try {
        resultDiv.textContent = 'Enviando imagem para análise...';

        const response = await fetch('https://backend-natal-solidario.onrender.com/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64Image })
        });

        const result = await response.json();

        resultDiv.innerHTML = '';

        if (result && typeof result === 'object') {
          for (const key in result) {
            const label = document.createElement('label');
            label.textContent = key + ': ';
            label.htmlFor = key;

            const input = document.createElement('input');
            input.type = 'text';
            input.id = key;
            input.value = result[key] === null ? '' : result[key];

            resultDiv.appendChild(label);
            resultDiv.appendChild(input);
            resultDiv.appendChild(document.createElement('br'));
          }
        } else {
          resultDiv.textContent = JSON.stringify(result, null, 2);
        }
      } catch (err) {
        resultDiv.textContent = 'Erro: ' + err.message;
      }
    });
  </script>
</body>
</html>
