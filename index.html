<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Doc - Captura de Foto A4</title>
</head>
<body>
  <h1>Captura de Foto</h1>

  <button id="start-camera">Ativar Câmera</button>
  <video id="video" width="320" height="240" autoplay playsinline style="display:none;"></video>
  <button id="snap" style="display:none;">Capturar</button>

  <canvas id="canvas" style="display:none;"></canvas>
  <div id="loading" style="display: none; color: blue; font-weight: bold; font-size: 18px;">Processando a imagem, aguarde até 1 minuto...</div>
  <div id="result" style="margin-top: 20px;"></div>

  <script>
    const startButton = document.getElementById('start-camera');
    const snapButton = document.getElementById('snap');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultDiv = document.getElementById('result');
    const ctx = canvas.getContext('2d');

    const dpi = 150;
    const mmToInch = 0.0393701;
    const a4WidthPx = Math.round(210 * mmToInch * dpi);
    const a4HeightPx = Math.round(297 * mmToInch * dpi);

    canvas.width = a4WidthPx;
    canvas.height = a4HeightPx;

    startButton.addEventListener('click', async () => {
      try {
        // Try rear camera
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: 'environment' } },
          audio: false
        });
        video.srcObject = stream;
        video.style.display = 'block';
        snapButton.style.display = 'inline-block';
        startButton.style.display = 'none';
      } catch (error) {
        // Fallback to any camera
        try {
          const fallbackStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' },
            audio: false
          });
          video.srcObject = fallbackStream;
          video.style.display = 'block';
          snapButton.style.display = 'inline-block';
          startButton.style.display = 'none';
        } catch (err) {
          console.error('Erro ao acessar a câmera:', err);
          resultDiv.textContent = 'Erro ao acessar a câmera: ' + err.message;
        }
      }
    });

  snapButton.addEventListener('click', async () => {
    const loadingDiv = document.getElementById('loading');
    resultDiv.innerHTML = '';
    loadingDiv.style.display = 'block';

    const videoRatio = video.videoWidth / video.videoHeight;
    const canvasRatio = canvas.width / canvas.height;

    let drawWidth, drawHeight, offsetX, offsetY;

    if (videoRatio > canvasRatio) {
      drawWidth = canvas.width;
      drawHeight = canvas.width / videoRatio;
      offsetX = 0;
      offsetY = (canvas.height - drawHeight) / 2;
    } else {
      drawHeight = canvas.height;
      drawWidth = canvas.height * videoRatio;
      offsetX = (canvas.width - drawWidth) / 2;
      offsetY = 0;
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);

    const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];

    try {
      const response = await fetch('https://backend-natal-solidario.onrender.com/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: base64Image })
      });

      const result = await response.text();
      const jsonResult = JSON.parse(result);
      console.log('Parsed JSON (jsonResult):', jsonResult);
      console.log("Raw AI response (result):", result);

      let parsed;

      if (jsonResult.error && jsonResult.raw) {
        let cleaned = jsonResult.raw.trim();

        if (cleaned.startsWith('```json')) {
          cleaned = cleaned.replace(/^```json/, '').replace(/```$/, '').trim();
        } else if (cleaned.startsWith('```')) {
          cleaned = cleaned.slice(3, -3).trim();
        }

        // Remove newlines and replace with space
        cleaned = cleaned.replace(/\\n|[\n\r]/g, ' ');

        // Extract JSON object from string if wrapped with extra chars
        const match = cleaned.match(/\{[\s\S]*\}/);
        if (match) cleaned = match[0];

        try {
          parsed = JSON.parse(cleaned);
        } catch (e) {
          resultDiv.textContent = 'Erro ao interpretar a resposta: ' + e.message;
          return;
        }
      } else {
        // If no error, just use the parsed result as-is
        parsed = jsonResult;
      }

      

      for (const key in parsed) {
        const label = document.createElement('label');
        label.textContent = key + ': ';

        const input = document.createElement('input');
        input.type = 'text';
        input.id = key;
        input.value = (parsed[key] === null || parsed[key] === "null") ? '' : String(parsed[key]).replace(/\n/g, ' ');
        input.style.width = '400px';
        label.htmlFor = key;

        resultDiv.appendChild(label);
        resultDiv.appendChild(input);
        resultDiv.appendChild(document.createElement('br'));
      }

    } catch (err) {
      resultDiv.textContent = 'Erro: ' + err.message;
    } finally {
      loadingDiv.style.display = 'none';
    }
  });
  </script>
</body>
</html>
