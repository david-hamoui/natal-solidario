<!DOCTYPE html>
<html>
<head>
  <title>Doc - Capture A4 Photo</title>
</head>
<body>
  <h1>Tirar a foto</h1>
  <video id="video" width="320" height="240" autoplay playsinline></video>
  <button id="snap">CAPTURAR</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result" style="margin-top: 20px;"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');

    // A4 size at 150 dpi
    const dpi = 150;
    const mmToInch = 0.0393701;
    const a4WidthPx = Math.round(210 * mmToInch * dpi);
    const a4HeightPx = Math.round(297 * mmToInch * dpi);

    canvas.width = a4WidthPx;
    canvas.height = a4HeightPx;

    // Try rear camera, fallback if unavailable
    let stream;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } },
          audio: false
        });
        video.srcObject = stream;
        snapBtn.disabled = false;
        startBtn.disabled = true;
      } catch (err) {
        // Fallback if exact facingMode fails
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false
          });
          video.srcObject = stream;
          snapBtn.disabled = false;
          startBtn.disabled = true;
        } catch (err2) {
          console.error('Erro ao acessar a câmera traseira:', err2);
          resultDiv.textContent = 'Erro ao acessar a câmera traseira: ' + err2.message;
        }
      }
    }

    startBtn.addEventListener('click', startCamera);

    snapBtn.addEventListener('click', async () => {
      if (!stream) {
        resultDiv.textContent = 'Câmera não iniciada.';
        return;
      }

      // Wait for video metadata to load for dimensions
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        resultDiv.textContent = 'Aguardando a câmera iniciar...';
        return;
      }

    document.getElementById('snap').addEventListener('click', async () => {
      // Center image on A4 canvas
      const videoRatio = video.videoWidth / video.videoHeight;
      const canvasRatio = canvas.width / canvas.height;

      let drawWidth, drawHeight, offsetX, offsetY;

      if (videoRatio > canvasRatio) {
        drawWidth = canvas.width;
        drawHeight = canvas.width / videoRatio;
        offsetX = 0;
        offsetY = (canvas.height - drawHeight) / 2;
      } else {
        drawHeight = canvas.height;
        drawWidth = canvas.height * videoRatio;
        offsetX = (canvas.width - drawWidth) / 2;
        offsetY = 0;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);

      const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];

      try {
        const response = await fetch('https://backend-natal-solidario.onrender.com/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64Image })
        });

        const result = await response.json();

        resultDiv.innerHTML = '';

        // If the result is an object (not plain text), show input fields
        let parsed = result;

        // If Gemini returns a single string instead of a parsed object
        if (typeof result === 'string') {
          let cleaned = result.trim();

          // Attempt to extract JSON-like content
          const match = cleaned.match(/\{[\s\S]*\}/);
          if (match) {
            cleaned = match[0];
          }

          // Replace \n with a space (important for malformed JSON)
          cleaned = cleaned.replace(/\\n|[\n\r]/g, ' ');

          try {
            parsed = JSON.parse(cleaned);
          } catch (e) {
            resultDiv.textContent = 'Erro ao interpretar a resposta: ' + e.message;
            return;
          }
        }

        for (const key in parsed) {
          const label = document.createElement('label');
          label.textContent = key + ': ';
          const input = document.createElement('input');
          input.type = 'text';
          input.value = (parsed[key] === null || parsed[key] === "null") ? '' : String(parsed[key]).replace(/\n/g, ' ');
          input.id = key;
          label.htmlFor = key;
          resultDiv.appendChild(label);
          resultDiv.appendChild(input);
          resultDiv.appendChild(document.createElement('br'));
        }

      } catch (err) {
        resultDiv.textContent = 'Erro: ' + err.message;
      }
    });
  </script>
</body>
</html>